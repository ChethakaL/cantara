generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  CLIENT
}

enum ClientStage {
  INITIAL_REVIEW
  IN_PROGRESS
  COMPLETED
}

model User {
  id                String            @id @default(cuid())
  name              String
  email             String            @unique
  passwordHash      String
  role              Role              @default(CLIENT)
  googleAccessToken String?
  googleRefreshToken String?
  googleTokenExpiry DateTime?
  googleDriveRootFolderId String?
  googleDriveRootFolderName String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  clientProfile     ClientProfile?
  createdRequests   DocumentRequest[] @relation("RequestsCreatedBy")
  uploadedDocuments ClientDocument[]  @relation("DocumentsUploadedBy")
  sessions          Session[]
  questionsAsked    Question[]
}

model ClientProfile {
  id                  String            @id @default(cuid())
  userId              String            @unique
  businessName        String
  businessDescription String
  stage               ClientStage       @default(INITIAL_REVIEW)
  driveFolderId       String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  requests            DocumentRequest[]
  documents           ClientDocument[]
  questions           Question[]
}

model Question {
  id          String    @id @default(cuid())
  clientId    String
  askedById   String
  question    String
  answer      String?
  answeredAt  DateTime?
  createdAt   DateTime  @default(now())
  client      ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  askedBy     User      @relation(fields: [askedById], references: [id], onDelete: Restrict)

  @@index([clientId, createdAt])
}

model DocumentRequest {
  id          String           @id @default(cuid())
  clientId    String
  title       String
  description String?
  createdById String
  dueDate     DateTime?
  createdAt   DateTime         @default(now())
  client      ClientProfile    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdBy   User             @relation("RequestsCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  documents   ClientDocument[]

  @@index([clientId, createdAt])
}

model ClientDocument {
  id                String          @id @default(cuid())
  requestId         String
  clientId          String
  uploadedById      String
  fileName          String
  mimeType          String
  size              Int
  localPath         String
  googleDriveFileId String?
  createdAt         DateTime        @default(now())
  request           DocumentRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  client            ClientProfile   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  uploadedBy        User            @relation("DocumentsUploadedBy", fields: [uploadedById], references: [id], onDelete: Restrict)

  @@index([requestId, createdAt])
  @@index([clientId, createdAt])
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}
